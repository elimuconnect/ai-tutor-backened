import express from "express";
import cors from "cors";
import dotenv from "dotenv";
import axios from "axios";

dotenv.config(); // MUST be first

const app = express();

// âœ… Middleware (ORDER MATTERS)
app.use(cors({
  origin: "*",
  methods: ["GET", "POST"],
  allowedHeaders: ["Content-Type"]
}));

app.use(express.json()); // replaces body-parser

// âœ… Health check
app.get("/", (req, res) => {
  res.send("âœ… AI Tutor backend running. Use POST /ask to talk to the AI.");
});

// âœ… Prevent 404 confusion
app.get("/ask", (req, res) => {
  res.status(405).json({ error: "Use POST /ask" });
});

// âœ… MAIN ENDPOINT
app.post("/ask", async (req, res) => {
  try {
    const { question, student } = req.body || {};

    if (!question) {
      return res.status(400).json({ error: "Question is required" });
    }

    // ðŸ”¹ TEMP TEST (IMPORTANT)
    // Comment this out after confirming frontend works
    return res.json({
      answer: `âœ… Backend OK. Question received: "${question}" (${student || "unknown"})`
    });

  } catch (err) {
    console.error("SERVER ERROR:", err);
    res.status(500).json({
      error: "Internal server error",
      details: err.message
    });
  }
});

// âœ… Render port handling
const PORT = process.env.PORT || 3000;
app.listen(PORT, () => {
  console.log("Server running on port", PORT);
});
